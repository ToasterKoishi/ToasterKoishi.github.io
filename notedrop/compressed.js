function calculateScore(a,b){const c=a[0],d=a[0]+a[1],e=a[2],f=2*d+e,g=f/(2*b);return Math.floor(1e6*g)+c}function checkPassiveJudgmentsUntil(a){for(let b=1;b<=9;b++){const d=lanes[b];let e;for(e=laneNextNoteIndices[b];e<d.length;e++){const f=d[e];if(f.holdNote){if(!(a>=f.timeEnd))break;noteHeld[b]&&dropHold(b,f.timeEnd),completeHold(b,f.timeEnd)}else{if(!(f.time+c[k]<a))break;prepareJudgment(k,b,a),f.holdStart&&(holdProgress[b]=0)}}laneNextNoteIndices[b]=e}}function dropHold(a,b){const c=lanes[a],d=laneNextNoteIndices[a],e=c[d],f=Math.max(0,b-holdStart[a]);noteHeld[a]=!1,holdProgress[a]+=f/(e.timeEnd-e.time)}function completeHold(a,b){for(let c=0;c<f.length;c++){const d=holdProgress[a],e=f[c];if(d>=1-e){prepareJudgment(c,a,b),laneNextNoteIndices[a]+=1;break}}}function prepareJudgment(a,b,c){judgmentQueue.push([a,b,c])}function completeJudgments(){judgmentQueue.sort((a,b)=>{return a[2]==b[2]?a[1]-b[1]:a[2]-b[2]});for(let a=0;a<judgmentQueue.length;a++){let b=judgmentQueue[a],c=b[0],d=b[2];judgments[c]+=1,showJudgment(c,d),c==i||c==k?combo=0:c<i&&(combo+=1)}judgmentQueue=[]}function showJudgment(a,b){judgeTime=b,judgeDiv.innerText=d[a],judgeDiv.style.color=e[a],a==g?judgeDiv.style.textShadow="0 0 1vh rgba(255,255,255,1)":judgeDiv.style.textShadow="0 0 1vh rgba(0,0,0,1)"}function start(){canvas=document.getElementById("glcanvas"),audio=document.createElement("AUDIO"),comboDiv=document.getElementById("combo"),judgeDiv=document.getElementById("judge"),scoreDiv=document.getElementById("score"),window.onkeydown=keyDownHandler,window.onkeyup=keyUpHandler,initWebGL(canvas),gl||alert("Couldn't set up WebGL."),gl.clearColor(0,0,0,1),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);const a=initTextures();initShaders(),initBuffers();initMusic();initGame();const c=initChart(),d=Promise.all([a,c]);d.then(()=>{setInterval(tick,15),setTimeout(()=>{audio.play(),document.getElementById("dom").style.visibility="visible"},15)})}function keyDownHandler(a){const b=audio.currentTime,d=l[a.key];if(!a.repeat&&d&&!keydown[d]){checkPassiveJudgmentsUntil(b);let a=!1;keydown[d]=!0;const e=lanes[d],f=laneNextNoteIndices[d],g=e[f];if(g)if(g.holdNote)noteHeld[d]=!0,holdStart[d]=b,a=!0;else{const e=b-g.time,f=Math.abs(e);for(let h=0;h<c.length;h++){const e=c[h];if(f<=e){prepareJudgment(h,d,b),g.holdStart&&(noteHeld[d]=!0,holdStart[d]=g.time,holdProgress[d]=0),laneNextNoteIndices[d]+=1,a=!0;break}}}if(!a){const a=e[f-1];if(a&&!a.holdNote){const e=b-a.time,f=Math.abs(e);f<=c[j]&&prepareJudgment(j,d,b)}}}}function keyUpHandler(a){const b=audio.currentTime,c=l[a.key];c&&keydown[c]&&(keydown[c]=!1,keybeam[c]=b,noteHeld[c]&&checkPassiveJudgmentsUntil(b),noteHeld[c]&&dropHold(c,b))}function initWebGL(){gl=null;try{gl=canvas.getContext("experimental-webgl")}catch(a){}gl||alert("Unable to initialize WebGL. Your browser may not support it.")}function initTextures(){return texGear=gl.createTexture(),texNote=gl.createTexture(),texHoldOuter=gl.createTexture(),texHoldInner=gl.createTexture(),texNote9=gl.createTexture(),texHold9Outer=gl.createTexture(),texHold9Inner=gl.createTexture(),texKeybeam=gl.createTexture(),Promise.all([loadTexture(texNote,b+"note.png"),loadTexture(texHoldOuter,b+"holdouter.png"),loadTexture(texHoldInner,b+"holdinner.png"),loadTexture(texGear,b+"gear.png"),loadTexture(texNote9,b+"note9.png"),loadTexture(texHold9Outer,b+"hold9outer.png"),loadTexture(texHold9Inner,b+"hold9inner.png"),loadTexture(texKeybeam,b+"keybeam.png")])}function loadTexture(a,b){return new Promise(function(c,d){const e=new Image;e.onload=function(){onTextureLoad(e,a),c()},e.onerror=d,e.crossOrigin="Anonymous",e.src=b})}function onTextureLoad(a,b){gl.bindTexture(gl.TEXTURE_2D,b),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null)}function initMusic(){return new Promise(function(a,b){audio.crossOrogin="Anonymous",audio.src="tokimeki.mp3",audio.onload=a,audio.onerror=b})}function initGame(){}function initChart(){return new Promise(function(a,c){let d=new XMLHttpRequest;d.open("GET",b+"chart.aff"),d.onreadystatechange=function(){if(4==d.readyState)if(200!==d.status&&0!=d.status)c();else{chart=[];const b=d.responseText.split("\n");for(let c=0;c<b.length;c++){console.log(b[c]);const a=b[c].trim();if(a.startsWith("AudioOffset"));else if(a.startsWith("(")){const b=a.substr(1,a.length-3).split(","),c=b[0],d=b[1];chart.push(new p(c/1e3,d))}else if(a.startsWith("hold")){const b=a.substr(5,a.length-7).split(","),c=b[0],d=b[1],e=b[2];console.log(b),chart.push(new p(c/1e3,e,!0)),chart.push(new p(c/1e3,e,!1,!0,d/1e3))}}lanes=[[],[],[],[],[],[],[],[],[],[]];for(let c=0;c<chart.length;c++){const a=chart[c];lanes[a.lane].push(a)}laneNextNoteIndices=[0,0,0,0,0,0,0,0,0,0],a()}},d.send()})}function initBuffers(){var a=[1,1,0,-1,1,0,1,-1,0,-1,-1,0];squareVerticesBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,squareVerticesBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a),gl.STATIC_DRAW);var b=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];squareVerticesColorBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,squareVerticesColorBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(b),gl.STATIC_DRAW);var c=[0,0,1,0,0,1,1,1];squareVerticesTexCoordBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,squareVerticesTexCoordBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(c),gl.STATIC_DRAW)}function tick(){tickGame();const a=audio.currentTime;drawCanvas(a),drawDOM(a)}function tickGame(){const a=audio.currentTime;checkPassiveJudgmentsUntil(a),completeJudgments()}function drawCanvas(a){gl.clear(gl.COLOR_BUFFER_BIT),canvas.width=canvas.clientWidth,canvas.height=canvas.clientHeight,gl.viewport(0,0,canvas.clientWidth,canvas.clientHeight);let b=canvas.clientWidth/canvas.clientHeight;perspectiveMatrix=makeOrtho(-1*b,b,-1,1,1,-1),gl.bindBuffer(gl.ARRAY_BUFFER,squareVerticesBuffer),gl.vertexAttribPointer(vertexPositionAttribute,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,squareVerticesColorBuffer),gl.vertexAttribPointer(vertexColorAttribute,4,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,squareVerticesTexCoordBuffer),gl.vertexAttribPointer(vertexTexCoordAttribute,2,gl.FLOAT,!1,0,0);const c=[9,1,2,3,4,5,6,7,8];drawGear();for(let d=0;d<c.length;d++){const b=c[d];if(keydown[b])drawKeybeam(b,1);else{const c=1-4*(a-keybeam[b]);c>0&&drawKeybeam(b,c)}}for(let d=0;d<c.length;d++){const b=c[d],e=lanes[b];for(let f=laneNextNoteIndices[b];f<e.length;f++){const c=e[f];if(c.time>=a+1)break;c.holdStart||c.holdNote?c.holdNote&&drawHold(c.lane,c.time-a,c.timeEnd-a,f==laneNextNoteIndices[b]&&noteHeld[c.lane]):drawNote(c.lane,c.time-a)}}}function drawDOM(a){comboDiv.innerText=combo,judgeDiv.style.opacity=Math.min(Math.max(0,4-4*(a-judgeTime)),1),scoreDiv.innerText=calculateScore(judgments,chart.length)}function drawGear(){color=[1,1,1,1],loadIdentity(),setMatrixUniforms(),bindTexture(texGear),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}function drawNote(b,c){c*=1.4,9==b?(color=a[b],loadIdentity(),mvTranslate([o[b],Math.max(0,m*c)+n,0]),mvScale([.5,.5/16,1]),mvTranslate([0,.5,0]),setMatrixUniforms(),bindTexture(texNote9),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)):(color=a[b],loadIdentity(),mvTranslate([o[b],Math.max(0,m*c)+n,0]),mvScale([1/16,.25/16,1]),mvTranslate([0,1,0]),setMatrixUniforms(),bindTexture(texNote),gl.drawArrays(gl.TRIANGLE_STRIP,0,4))}function drawHold(b,c,d,e){c*=1.4,d*=1.4;const f=Math.max(0,m*c)+n,g=Math.max(0,m*d)+n;color=a[b],e||(color=[.5*color[0],.5*color[1],.5*color[2],1]),9==b?(loadIdentity(),mvTranslate([o[b],f,0]),mvScale([.5,(g-f)/2,1]),mvTranslate([0,1,0]),setMatrixUniforms(),bindTexture(texHold9Inner),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),color=a[b],loadIdentity(),mvTranslate([o[b],f,0]),mvScale([.5,.5/16,1]),mvTranslate([0,.5,0]),setMatrixUniforms(),bindTexture(texHold9Outer),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)):(loadIdentity(),mvTranslate([o[b],f,0]),mvScale([1/16,(g-f)/2,1]),mvTranslate([0,1,0]),setMatrixUniforms(),bindTexture(texHoldInner),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),color=a[b],loadIdentity(),mvTranslate([o[b],f,0]),mvScale([1/16,.25/16,1]),mvTranslate([0,1,0]),setMatrixUniforms(),bindTexture(texHoldOuter),gl.drawArrays(gl.TRIANGLE_STRIP,0,4))}function drawKeybeam(a,b){color=[1,1,1,.5*b],loadIdentity(),mvTranslate([o[a],n,0]),mvScale(9==a?[.375,.109375,1]:[1/16,.4375,1]),mvTranslate([0,1,0]),setMatrixUniforms(),bindTexture(texKeybeam),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}function initShaders(){var a=getShader(gl,"shader-fs"),b=getShader(gl,"shader-vs");shaderProgram=gl.createProgram(),gl.attachShader(shaderProgram,b),gl.attachShader(shaderProgram,a),gl.linkProgram(shaderProgram),gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)||alert("Unable to initialize the shader program: "+gl.getProgramInfoLog(shader)),gl.useProgram(shaderProgram),vertexPositionAttribute=gl.getAttribLocation(shaderProgram,"aVertexPosition"),gl.enableVertexAttribArray(vertexPositionAttribute),vertexColorAttribute=gl.getAttribLocation(shaderProgram,"aVertexColor"),gl.enableVertexAttribArray(vertexColorAttribute),vertexTexCoordAttribute=gl.getAttribLocation(shaderProgram,"aTexCoord"),gl.enableVertexAttribArray(vertexTexCoordAttribute)}function getShader(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=a.createShader(a.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=a.createShader(a.VERTEX_SHADER)}return a.shaderSource(f,d),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(alert("An error occurred compiling the shaders: "+a.getShaderInfoLog(f)),null)}function loadIdentity(){mvMatrix=Matrix.I(4)}function multMatrix(a){mvMatrix=mvMatrix.x(a)}function mvTranslate(a){multMatrix(Matrix.Translation($V([a[0],a[1],a[2]])).ensure4x4())}function mvScale(a){multMatrix(Matrix.Scale($V([a[0],a[1],a[2]])).ensure4x4())}function setMatrixUniforms(){var a=gl.getUniformLocation(shaderProgram,"uPMatrix");gl.uniformMatrix4fv(a,!1,new Float32Array(perspectiveMatrix.flatten()));var b=gl.getUniformLocation(shaderProgram,"uMVMatrix");gl.uniformMatrix4fv(b,!1,new Float32Array(mvMatrix.flatten()));var c=gl.getUniformLocation(shaderProgram,"vColorTransform");gl.uniform4fv(c,new Float32Array(color))}function bindTexture(a){var b=gl.getUniformLocation(shaderProgram,"uSampler");gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,a),gl.uniform1i(b,0)}var canvas,audio,comboDiv,judgeDiv,scoreDiv,chart,lanes,laneNextNoteIndices;var totalNotes,gl,squareVerticesBuffer,squareVerticesColorBuffer,squareVerticesTexCoordBuffer,mvMatrix,shaderProgram,vertexPositionAttribute,vertexColorAttribute,vertexTexCoordAttribute,perspectiveMatrix,color,combo=0,judgmentQueue=[],judgeTime=-10,judgments=[0,0,0,0,0,0],keydown=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],keybeam=[-10,-10,-10,-10,-10,-10,-10,-10,-10,-10],noteHeld=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],holdStart=[0,0,0,0,0,0,0,0,0,0],holdProgress=[0,0,0,0,0,0,0,0,0,0];var texNote,texHoldOuter,texHoldInner,texNote9,texHold9Outer,texHold9Inner,texGear,texKeybeam,texturesLoaded=0;
